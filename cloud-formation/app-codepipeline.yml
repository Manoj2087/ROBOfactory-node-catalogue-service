AWSTemplateFormatVersion: '2010-09-09'
Description: 'Deploy app codepipline'
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
    - Label:
        default: 'GitHub Info'
      Parameters:
      - GitHubOwner
      - RepositoryName
      - BranchName
    - Label:
        default: 'Codebuild'
      Parameters:
      - MyAppBuildSpecPath
#Input Parameters
Parameters:
  MyAppName:
    Default: 'robofactory'
    Description: 'My App name'
    Type: String
  MyAppBuildSpecPath:
    Default: 'buildspec.yml'
    Description: 'Location of the buildspec file in your project'
    Type: String
  RepositoryName:
    Description: GitHub repository name
    Type: String
    Default: test
  BranchName:
    Description: GitHub branch name
    Type: String
    Default: master
  GitHubOwner:
    Type: String
  
#Build AWs resources
Resources:
  # Test Infra
  TestRobotCatalogueTable: 
    Type: AWS::DynamoDB::Table
    Properties: 
      TableName:
        Fn::Join:
          - '-'
          - - 'test'
            - 'robot-catalogue'
      AttributeDefinitions: 
        - 
          AttributeName: "R_NAME"
          AttributeType: "S"
        - 
          AttributeName: "R_TYPE"
          AttributeType: "S"
      KeySchema: 
        - 
          AttributeName: "R_NAME"
          KeyType: "HASH"
      ProvisionedThroughput: 
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      GlobalSecondaryIndexes: 
        - 
          IndexName: 'type-index'
          KeySchema: 
            - 
              AttributeName: "R_TYPE"
              KeyType: "HASH"
          Projection: 
            NonKeyAttributes: 
              - "R_NAME"
              - "R_IMG_URL"
            ProjectionType: "INCLUDE"
          ProvisionedThroughput: 
            ReadCapacityUnits: 5
            WriteCapacityUnits: 5
  # TestMyAppTaskDefinition:
  #   Type: AWS::ECS::TaskDefinition
  #   Properties: 
  #     ContainerDefinitions: 
  #       - Command: 
  #           - run
  #           - test
  #         Cpu: 512
  #         Environment: 
  #           - MYAPP_AWS_REGION: !Ref AWS::Region
  #           - MYAPP_AWS_ENDPOINT: !Sub "https://dynamodb.{AWS::Region}.amazonaws.com"
  #           - MYAPP_ROBOT_TABLE: !Ref TestRobotCatalogueTable
  #           - MYAPP_ROBOT_T_TYPE_INDEX: "type-index"
  #         Image: String
  #         Interactive: Boolean
  #         Links: 
  #           - String
  #         LinuxParameters: 
  #           LinuxParameters
  #         LogConfiguration: 
  #           LogConfiguration
  #         Memory: Integer
  #         MemoryReservation: Integer
  #         MountPoints: 
  #           - MountPoint
  #         Name: String
  #         PortMappings: 
  #           - PortMapping
  #         Privileged: Boolean
  #         PseudoTerminal: Boolean
  #         ReadonlyRootFilesystem: Boolean
  #         RepositoryCredentials: 
  #           RepositoryCredentials
  #         ResourceRequirements: 
  #           - ResourceRequirement
  #         Secrets: 
  #           - Secret
  #         StartTimeout: Integer
  #         StopTimeout: Integer
  #         SystemControls: 
  #           - SystemControl
  #         Ulimits: 
  #           - Ulimit
  #         User: String
  #         VolumesFrom: 
  #           - VolumeFrom
  #         WorkingDirectory: String
  #     Cpu: String
  #     ExecutionRoleArn: String
  #     Family: String
  #     InferenceAccelerators: 
  #       - InferenceAccelerator
  #     IpcMode: String
  #     Memory: String
  #     NetworkMode: String
  #     PidMode: String
  #     PlacementConstraints: 
  #       - TaskDefinitionPlacementConstraint
  #     ProxyConfiguration: 
  #       ProxyConfiguration
  #     RequiresCompatibilities: 
  #       - String
  #     Tags: 
  #       - Tag
  #     TaskRoleArn: String
  #     Volumes: 
  #       - Volume
  # Prod Infra
  ProdRobotCatalogueTable: 
    Type: AWS::DynamoDB::Table
    Properties: 
      TableName:
        Fn::Join:
          - '-'
          - - 'prod'
            - 'robot-catalogue'
      AttributeDefinitions: 
        - 
          AttributeName: "R_NAME"
          AttributeType: "S"
        - 
          AttributeName: "R_TYPE"
          AttributeType: "S"
      KeySchema: 
        - 
          AttributeName: "R_NAME"
          KeyType: "HASH"
      ProvisionedThroughput: 
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      GlobalSecondaryIndexes: 
        - 
          IndexName: 
            Fn::Join:
              - '-'
              - - 'prod'
                - 'type-index'
          KeySchema: 
            - 
              AttributeName: "R_TYPE"
              KeyType: "HASH"
          Projection: 
            NonKeyAttributes: 
              - "R_NAME"
              - "R_IMG_URL"
            ProjectionType: "INCLUDE"
          ProvisionedThroughput: 
            ReadCapacityUnits: 5
            WriteCapacityUnits: 5
  MyCodeBuildLogGroup:
    Type: AWS::Logs::LogGroup
    Properties: 
      RetentionInDays: 7
  MyCodeBuildLogStream:
    Type: AWS::Logs::LogStream
    Properties: 
      LogGroupName: !Ref MyCodeBuildLogGroup
      LogStreamName: "MyAppLogStream"
  MyCodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: [codebuild.amazonaws.com]
          Action: ['sts:AssumeRole']
      Path: /
      Policies:
      - PolicyName: codebuild
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action: '*'
            Resource: '*'
  MyCodeBuild:
    Type: AWS::CodeBuild::Project
    Properties: 
      Artifacts: 
        OverrideArtifactName: true
        Type: 'CODEPIPELINE'
      Description: 'my app codebuild'
      Environment: 
        ComputeType: 'BUILD_GENERAL1_SMALL'
        Image: 'aws/codebuild/amazonlinux2-x86_64-standard:3.0'
        PrivilegedMode: true
        Type: 'LINUX_CONTAINER'
      LogsConfig: 
        CloudWatchLogs: 
          GroupName: !Ref MyCodeBuildLogGroup
          Status: 'ENABLED'
          StreamName: !Ref MyCodeBuildLogStream
      ServiceRole: !Ref MyCodeBuildRole
      Source: 
        Type: 'CODEPIPELINE'
        BuildSpec: !Ref MyAppBuildSpecPath
  MyAppCodePipelineS3ArtifactStore:
    Type: AWS::S3::Bucket
  MyAppECSRepo:
    Type: AWS::ECR::Repository
    Properties: 
      RepositoryName: !Join 
          - ''
          - - !Ref MyAppName
            - '/'
            - !Ref AWS::StackName
  MyCodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: [codepipeline.amazonaws.com]
          Action: ['sts:AssumeRole']
      Path: /
      Policies:
      - PolicyName: codepipeline
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action: '*'
            Resource: '*'
  MyAppCodePipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties: 
      ArtifactStore: 
        Location: !Ref MyAppCodePipelineS3ArtifactStore
        Type: 'S3'
      RoleArn: !GetAtt MyCodePipelineRole.Arn
      Stages: 
        - Name: 'Source'
          # https://docs.aws.amazon.com/codepipeline/latest/userguide/reference-pipeline-structure.html#actions-valid-providers
          Actions:
            - Name: ApplicationSource
              ActionTypeId: 
                Category: 'Source'
                Owner: 'ThirdParty'
                Provider: 'GitHub'
                Version: '1'
              Configuration: 
                Owner: !Ref GitHubOwner
                Repo: !Ref RepositoryName
                PollForSourceChanges: false
                Branch: !Ref BranchName
                OAuthToken: '{{resolve:secretsmanager:my-app-secrets:SecretString:git-personal-access-token}}'
              InputArtifacts: []
              OutputArtifacts: 
                - Name: SourceArtifact
              RunOrder: 1
        - Name: 'Build'
          Actions:
            - Name: BuildContainer
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: !Ref MyCodeBuild
                PrimarySource: SourceArtifact
                EnvironmentVariables: !Sub |
                  [
                    {
                      "name":"REPOSITORY_URI",
                      "value":"${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${MyAppECSRepo}",
                      "type":"PLAINTEXT"
                    }
                  ]
              OutputArtifacts:
                - Name: BuildArtifact
              InputArtifacts:
                - Name: SourceArtifact
              RunOrder: 2
  MyAppGitHubWebHook:
    Type: AWS::CodePipeline::Webhook
    Properties: 
      Authentication: 'GITHUB_HMAC'
      AuthenticationConfiguration: 
        SecretToken: '{{resolve:secretsmanager:my-app-secrets:SecretString:git-personal-access-token}}'
      Filters: 
        - JsonPath: $.ref
          MatchEquals: 'refs/heads/{Branch}'
      RegisterWithThirdParty: true
      TargetAction: 'ApplicationSource'
      TargetPipeline: !Ref MyAppCodePipeline
      TargetPipelineVersion: !GetAtt MyAppCodePipeline.Version

Outputs:
  StackName:
    Description: 'Stack name'
    Value: !Sub '${AWS::StackName}'